document.addEventListener("alpine:init",()=>{window.Alpine.data("versionDiffController",function(){return console.log("Initializing versionDiffController"),{expandAll(){this.$root.querySelectorAll("[data-collapsible-item]").forEach(r=>{let a=Alpine.$data(r);a&&"expanded"in a&&(a.expanded=!0)})},collapseAll(){this.$root.querySelectorAll("[data-collapsible-item]").forEach(r=>{let a=Alpine.$data(r);a&&"expanded"in a&&(a.expanded=!1)})}}}),window.Alpine.data("diffChecker",function({newValue:r,oldValue:a}){return{oldValue:a,newValue:r,diff:[],inlineDiffHtml:"",init(){this.calculateDiff()},getOldValue(){return this.oldValue||""},getNewValue(){return this.newValue||""},calculateDiff(){let e=this.getOldValue(),t=this.getNewValue();if(!e&&!t){this.diff=[];return}let i=this.tokenize(e),n=this.tokenize(t);this.diff=this.generateWordDiff(i,n),this.inlineDiffHtml=this.getInlineDiff()},tokenize(e){let t=[],i=/(\S+|\s+)/g,n;for(;(n=i.exec(e))!==null;)t.push(n[1]);return t},generateWordDiff(e,t){let i=[],n=0,l=0,h=this.longestCommonSubsequence(e,t),f=0;for(;n<e.length||l<t.length;){let o=e[n],s=t[l];if(n<e.length&&l<t.length&&o===s)i.push({type:"unchanged",content:o}),n++,l++;else{let c=!1,g=20;for(let u=0;u<=g&&n+u<e.length;u++){for(let p=0;p<=g&&l+p<t.length;p++)if(e[n+u]===t[l+p]&&h.includes(e[n+u])){for(let d=0;d<u;d++)i.push({type:"removed",content:e[n+d]});for(let d=0;d<p;d++)i.push({type:"added",content:t[l+d]});n+=u,l+=p,c=!0;break}if(c)break}c||(n<e.length&&l<t.length?(i.push({type:"removed",content:o}),i.push({type:"added",content:s}),n++,l++):n<e.length?(i.push({type:"removed",content:o}),n++):l<t.length&&(i.push({type:"added",content:s}),l++))}}return i},generateDiff(e,t){let i=[],n=0,l=0,h=this.longestCommonSubsequence(e,t);for(;n<e.length||l<t.length;){let f=e[n],o=t[l],s=h.includes(f)&&n<e.length,c=h.includes(o)&&l<t.length;n<e.length&&l<t.length&&f===o?(i.push({type:"unchanged",content:f,oldLineNum:n+1,newLineNum:l+1}),n++,l++):n<e.length&&(!c||l>=t.length||!s)?(i.push({type:"removed",content:f,oldLineNum:n+1,newLineNum:null}),n++):l<t.length&&(i.push({type:"added",content:o,oldLineNum:null,newLineNum:l+1}),l++)}return i},longestCommonSubsequence(e,t){let i=e.length,n=t.length,l=Array(i+1).fill().map(()=>Array(n+1).fill(0));for(let s=1;s<=i;s++)for(let c=1;c<=n;c++)e[s-1]===t[c-1]?l[s][c]=l[s-1][c-1]+1:l[s][c]=Math.max(l[s-1][c],l[s][c-1]);let h=[],f=i,o=n;for(;f>0&&o>0;)e[f-1]===t[o-1]?(h.unshift(e[f-1]),f--,o--):l[f-1][o]>l[f][o-1]?f--:o--;return h},getInlineDiff(){if(this.diff.length===0)return"";let e="";for(let t=0;t<this.diff.length;t++){let i=this.diff[t];i.type==="unchanged"?e+=this.escapeHtml(i.content):i.type==="removed"?e+=`<span class="deleted-text">${this.escapeHtml(i.content)}</span>`:i.type==="added"&&(e+=`<span class="added-text">${this.escapeHtml(i.content)}</span>`)}return e},escapeHtml(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML}}})});
